<!DOCTYPE html>
<html lang="en">
<head>
	<title>Embedded Applet - GeoGebra</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1"/>
	<link rel="shortcut icon" href="https://www.geogebra.org/apps/icons/geogebra.ico" type="image/x-icon">
	<link rel="icon" href="https://www.geogebra.org/apps/icons/geogebra.ico" type="image/x-icon">
	<link rel="stylesheet" href="https://unpkg.com/mvp.css">
	<style>
		body {
			font-family: sans-serif;
		}

		label {
			min-width: 160px;
			display: inline-block;
		}

		#settings {
			position: absolute;
			right: 0;
			top: 64px;
			max-height: calc(100% - 64px);
			overflow-y: auto;
			z-index: 1000;
			font-size: 12px;
			background-color: rgba(255, 255, 255, 0.9);
		}
		#settings input {
			margin-bottom: 0;
		}

		#scaleContainer {
			position: absolute;
			top: 100px;
			left: 100px;
			background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 10 10' xmlns='http://www.w3.org/2000/svg' width='10' height='10'%3E%3Cpolygon points='0,0 2,5 0,10 5,8 10,10 8,5 10,0 5,2' fill='%23EEEEEE'/%3E%3C/svg%3E");
		}

		#resizer {
			visibility: hidden;
			position: absolute;
			background-color: #eeeeee;
			border-radius: 50%;
			width: 48px;
			height: 48px;
			line-height: 48px;
			text-align: center;
			left: 100%;
		}

		#glasspane {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			visibility: hidden;
			z-index: 2000;
		}

		#filter {
			display: inline;
		}

		.popupImg {
			position: absolute;
			z-index: 3000;
			left: 0;
		}
	</style>

	<script type="text/javascript">
		const params = {
			"module": ["select", "web3d", "webSimple"],
			"appName": ["select", "classic", "graphing", "geometry", "3d", "scientific", "notes", "evaluator", "suite"],
			"smoothing": "number",
			"blur": "number",
			"showToolBar": "boolean",
			"tubeID": "text",
			"fileName": "text",
			"ggbbase64": "text",
			"allowStyleBar": "boolean",
			"showToolBarHelp": ["boolean", true],
			"enableLabelDrags": ["boolean", true],
			"enableShiftDragZoom": ["boolean", true],
			"showLogging": ["select", "true", "false", "graphics"],
			"width": ["text", 800],
			"height": ["text", 600]
		};

		function decode(el, param) {
			var fallback = false;
			if (typeof params[param] == "object") {
				fallback = params[param][1];
			}
			if (el.type === "checkbox") {
				return el.checked === fallback ? null : (el.checked + "");
			}
			return el.value.length && el.value !== fallback ? el.value : null;
		}

		function onParamChange(param, val, article) {
			if (param === "scaleContainerClass") {
				document.getElementById("scaleContainer").className += " " + val;
				document.getElementById("resizer").style.visibility = val ? "visible" : "hidden";
				var style = document.getElementById("scaleContainer").style;
				style.width = style.width || "800px";
				style.height = style.height || "600px";
			}
			if (val) {
				article.setAttribute("data-param-" + param, val);
			} else {
				article.removeAttribute("data-param-" + param);
			}
		}

		function updateParams(article) {
			var url = location.protocol + "//" + location.host + location.pathname + "?";
			var reloadNeeded = false;
			for (param in params) {
				var val = decode(document.getElementById("set" + param), param);
				onParamChange(param, val, article);
				if (val === "true") {
					url += param + "&";
				} else if (val) {
					url += param + "=" + encodeURIComponent(val) + "&";
				}
				if (param === "module" && val && !window[val]) {
					reloadNeeded = true;
				}
			}
			if (reloadNeeded) {
				location.href = url;
			} else {
				history.pushState("", "", url);
			}
			renderGGBElement(article);
		}

		window.addEventListener("load", function () {

			var article = document.createElement("div");

			for (param in params) {
				type = typeof params[param] == "object" ? params[param][0]
					: params[param];
				var input = document.createElement(type === "select" ? "select"
					: "input");
				if (type === "select") {
					for (var opt = 1; opt < params[param].length; opt++) {
						var optVal = params[param][opt];
						var optTag = document.createElement("option");
						optTag.innerText = optVal;
						optTag.value = optVal;
						input.appendChild(optTag);
					}
				}
				label = document.createElement("label");
				label.innerText = param;

				val = typeof params[param] == "object" ? params[param][1] : null;
				input.type = type.replace("boolean", "checkbox");
				if (type === "boolean") {
					input.checked = !!val;
				} else {
					input.value = val;
				}
				if (val !== null) {
					article.setAttribute("data-param-" + param, val);
				}
				input.id = input.name = "set" + param;
				input.addEventListener("change", function () {
					updateParams(article);
				});
				label.setAttribute("for", "set" + param);
				field = document.createElement("div");
				field.setAttribute("data-for", param.toLowerCase());
				field.appendChild(label);
				field.appendChild(input);
				document.getElementById("settings").appendChild(field);
			}

			article.className = "geogebraweb";
			document.getElementById("parent").appendChild(article);
			settings = location.search.substring(1).split("&");
			var module = "web3d";

			for (i in settings) {
				var parts = settings[i].split("=");
				if (params[parts[0]]) {
					var val = decodeURIComponent(parts[1] || "true");
					if (parts[0] === "module") {
						module = val;
					} else {
						onParamChange(parts[0], val, article);
					}
					const input = document.getElementById("set" + parts[0]);
					if (input.type === 'checkbox') {
						input.checked = val === "true";
					} else {
						input.value = val;
					}
				}
			}

			var w3d = document.createElement("script");
			w3d.src = module + "/" + module + ".nocache.js";
			document.body.appendChild(w3d);
			var resizer = document.getElementById("resizer");
			var glasspane = document.getElementById("glasspane");
			resizer.addEventListener("pointerdown", function () {
				resizer.dragging = true;
				glasspane.style.visibility = "visible";
			});
			glasspane.addEventListener("pointerup", function () {
				resizer.dragging = false;
				glasspane.style.visibility = "hidden";
			});
			glasspane.addEventListener("pointermove", function (e) {
				if (resizer.dragging) {
					var x = e.x - 100;
					var y = e.y - 100;
					document.getElementById("scaleContainer").style.width = x + "px";
					document.getElementById("scaleContainer").style.height = y + "px";
					resizer.style.left = (x - 24) + "px";
					resizer.style.top = (y - 24) + "px";
				}
			});
			document.getElementById("hide").addEventListener("click", function(e) {
				const style = document.getElementById("settings").style;
				style.display = style.display == "none" ? "" : "none";
			});
			document.getElementById("filter").addEventListener("input", function(e) {
				document.querySelectorAll("[data-for]").forEach(el => {
					el.style.display = el.getAttribute("data-for").includes(document.getElementById("filter").value.toLowerCase()) ? "" : "none";
				});
			});

		});
	</script>
</head>
<body>
<button id="hide">Show / Hide Settings</button>

<div id="settings"><div><input type="search" id="filter"/>ðŸ”Ž</div></div>
<div id="scaleContainer">
	<div>
		<div id="parent"></div>
	</div>
	<div id="resizer">
		&#x2194;
	</div>
</div>
<div id="glasspane"></div>
<div id="status"></div>
</body>
</html>
